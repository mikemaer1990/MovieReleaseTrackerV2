name: Daily Website Ping with Notifications

on:
  schedule:
    - cron: '0 14 * * *'
  workflow_dispatch:

jobs:
  ping-website:
    runs-on: ubuntu-latest
    
    steps:
      - name: Wake up website
        id: wakeup
        run: |
          echo "Waking up Movie Release Tracker..."
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            https://moviereleasetrackerv2.onrender.com/ || echo "000")
          echo "wakeup_code=$response" >> $GITHUB_OUTPUT
          sleep 30
      
      - name: Execute release check script
        id: main_ping
        run: |
          echo "Running daily release check..."
          
          # Try main script
          response=$(curl -s -w "%{http_code}|%{time_total}" -o /tmp/response.txt \
            "https://moviereleasetrackerv2.onrender.com/check-releases?key=jumbletree" || echo "000|0")
          
          http_code=$(echo $response | cut -d'|' -f1)
          time_total=$(echo $response | cut -d'|' -f2)
          
          echo "main_code=$http_code" >> $GITHUB_OUTPUT
          echo "response_time=$time_total" >> $GITHUB_OUTPUT
          
          if [ $http_code -eq 200 ]; then
            echo "✅ Success! Response: $http_code (${time_total}s)"
            echo "Response body:"
            cat /tmp/response.txt
          else
            echo "❌ Failed with code: $http_code"
            echo "Retrying in 60 seconds..."
            sleep 60
            
            # Retry
            retry_response=$(curl -s -w "%{http_code}" -o /tmp/retry_response.txt \
              "https://moviereleasetrackerv2.onrender.com/check-releases?key=jumbletree" || echo "000")
            
            echo "retry_code=$retry_response" >> $GITHUB_OUTPUT
            
            if [ $retry_response -eq 200 ]; then
              echo "✅ Retry successful! Code: $retry_response"
            else
              echo "❌ Retry also failed with code: $retry_response"
              exit 1
            fi
          fi
      
      # Optional: Send notification on failure (requires webhook URL secret)
      - name: Notify on failure
        if: failure()
        run: |
          echo "Sending failure notification..."
          # Example: Discord webhook
          # curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
          #   -H "Content-Type: application/json" \
          #   -d '{"content": "🚨 Movie Release Tracker daily check failed!"}'
      
      - name: Summary
        run: |
          echo "## Movie Release Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Wake-up response: ${{ steps.wakeup.outputs.wakeup_code }}" >> $GITHUB_STEP_SUMMARY
          echo "- Main ping response: ${{ steps.main_ping.outputs.main_code }}" >> $GITHUB_STEP_SUMMARY
          echo "- Response time: ${{ steps.main_ping.outputs.response_time }}s" >> $GITHUB_STEP_SUMMARY
          echo "- Completed at: $(date)" >> $GITHUB_STEP_SUMMARY
